<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />

        <title>SIMULATOR - FiveSecondGames</title>
        <meta name="description" content="FiveSecondGames" />
        <meta name="author" content="FSG" />
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://localhost:* https://*.fivesecondgames.com https://*.socket.io https://*.jsdelivr.net 'unsafe-inline';" />

        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
            crossorigin="anonymous"
        />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
            crossorigin="anonymous"
        ></script>

        <script
            src="https://cdn.socket.io/3.1.3/socket.io.min.js"
            integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <style>
            html,
            body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background-color:#1a202c;
                color:white;
            }


            #wrapper {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                height: 100%;
                position:relative;
                /* overflow-x:hidden; */
            }

            #wrapper .sidebar {
                padding-bottom:1rem;
                width:50%;
            }

            #wrapper #maincontent {
                /* flex-basis: 0;
                flex-grow: 999; */
                
            }

            #wrapper {
                border: 0;
                border-spacing: 0;
                
            }

            #maincontent::after {
                content: '';
                display:block;
                padding-bottom:56.25%;
            }
            #maincontent {
                position:relative;
                width:100%;
                /* max-width:1000px; */
                /* aspect-ratio: 16 / 9; */
                /* max-width: 1000px; */
                /* background-color: red; */
                /* resize: both; */
                
            }
            #placeholder {
                width:100%;
                height:100%;
                object-fit:fill;
                position:absolute;
                background-color:transparent;
            }
            #game-sandbox {
                width: 100%;
                height: 100%;
                position:absolute;
                backface-visibility: hidden;
                background-color:white;
                /* border: 4px solid rgb(11, 14, 19); */
                border-radius:8px;
            }
        </style>
        <div id="wrapper">
            <div class="sidebar">
                <h2 id="note">Status: offline</h2>
                <form>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input
                            type="text"
                            class="form-control"
                            id="username"
                            aria-describedby="userHelp"
                            placeholder="Enter username"
                        />
                        <small id="userHelp" class="form-text text-muted">Enter a username to join the game</small>
                    </div>

                    <button id="joingame" type="button" class="btn btn-primary">Join Game</button>
                    <button id="leavegame" type="button" class="btn btn-primary">Leave Game</button>
                    <button id="reload" type="button" class="btn btn-primary">Reload</button>
                    <button id="maximize" type="button" class="btn btn-primary">Maximize Window</button>
                    
                        <input type="checkbox" class="form-check-input" id="scaled">
                        <label class="form-check-label" for="exampleCheck1">Scaled?</label>
                    
                </form>
            </div>
            <div id="maincontent">
                <div id="placeholder"><iframe id="game-sandbox" sandbox="allow-scripts" src="/iframe"></iframe></div>
                
            </div>
        </div>

        <script>
            var socket = null;
            var lastMessage = null;
            let note = document.getElementById('note');
            let maincontent = document.getElementById('maincontent');
            let placeholder = document.getElementById('placeholder');
            let iframe = document.getElementById('game-sandbox');
            let nameField = document.getElementById('username');
            nameField.value = getUsername();
            nameField.onkeyup = (event) => {
                let username = event.target.value;
                updateUser(username);
            };

            iframe.style.display = 'none';
            var scaled =false;
            var CONTENT_WIDTH = 1920;
            var CONTENT_HEIGHT = 1080;
            var timestamp = 0;
            var THROTTLE = 0;
            
            function openFullscreen(elem) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
                maincontent.style.width = '100%';
                onResize();
            }

            function transformStr(obj) {
                var obj = obj || {},
                    val = '',
                    j;
                for ( j in obj ) {
                val += j + '(' + obj[j] + ') ';
                }
                
                return '-webkit-transform: ' + val + '; ' +
                        '-moz-transform: ' + val + '; ' +
                        'transform: ' + val;
            }

            function checkFullScreen() {
                if (document.fullscreenElement || document.webkitFullscreenElement ||
                    document.mozFullScreenElement)
                        return true;
                else
                        return false;
            }

            function onResize() {
                var now = +new Date,
                    winWidth = window.innerWidth,
                    scale,
                    width,
                    height,
                    offsetTop,
                    offsetLeft;
                
                if ( now - timestamp < THROTTLE  ) {
                    return onResize;
                }
                
                timestamp = now;

                let isFullscreen = checkFullScreen();
                let windowHeight = isFullscreen ? window.screen.height : document.documentElement.clientHeight;
                let windowWidth = isFullscreen ? window.screen.width : document.documentElement.clientWidth;
                var bgWidth = parseInt(getComputedStyle(maincontent).width, 10);
                var bgHeight = parseInt(getComputedStyle(maincontent).height, 10);
                var iframeWidth =  parseInt(getComputedStyle(iframe).width, 10);
                let ratio = 1;

                if( bgHeight >= windowHeight ) {
                    ratio = (windowHeight/bgHeight  );
                }
                else if( bgWidth >= windowWidth ) {
                    ratio =  (windowWidth/bgWidth  );
                }
                else {
                    ratio = (windowWidth/bgWidth  );
                    if( bgHeight*ratio >= windowHeight ) {
                        ratio = (windowHeight/bgHeight  );
                    }
                }
                bgWidth *= ratio;
                let steps = Math.floor(bgWidth / 16);
                bgWidth = Math.round(steps * 16);
                bgHeight = Math.round(steps * 9);
            
                maincontent.style.width = bgWidth + 'px';
                maincontent.style.height = bgHeight + 'px';
                
                scale = ((bgWidth / CONTENT_WIDTH));
           
                offsetLeft = 0;
                   
                if( scaled ) {
                    iframe.setAttribute('style', transformStr({
                    scale: scale,
                    translateX:  offsetLeft + 'px',
                    translateY:  offsetLeft + 'px',
                    translateZ: '0'
                }) + '; transform-origin: left top; width:1920px; height:1080px;');
                } else {
                    iframe.setAttribute('style', 'width:100%; height:100%;')
                }
            }
            
            window.addEventListener('resize', onResize, false);

            function connect(username, onjoin) {
                note.textContent = 'Status: connecting...';

                if (socket && !socket.disconnected) {
                    socket.disconnect();
                }

                socket = io('ws://localhost:3200', {
                    transports: ['websocket'],
                    upgrade: true,
                    query: 'username=' + username,
                });

                socket.on('connect', (evt) => {
                    if (onjoin) onjoin(evt);
                    window.sessionStorage.setItem('connected', true);

                    note.textContent = 'Status: connected';
                    iframe.style.display = 'block';
                });

                var latency = 0;
                var latencyStart = 0;
                var offsetTime = 0;
                socket.on('connected', (message) => {
                    //message should have { id, name }
                    socket.user = message;
                    updateLatency();
                });

                function updateLatency() {
                    latencyStart = new Date().getTime();
                    socket.emit('time', { payload: latencyStart });
                }

                function isObject(x) {
                    return x != null && (typeof x === 'object' || typeof x === 'function') && !Array.isArray(x);
                }
                function merge(from, delta) {
                    // if (!this.isObject(delta)) {
                    //     return from;
                    // }
                    if (!Array.isArray(delta) && !isObject(delta)) {
                        if (delta != from) return delta;
                    }

                    for (var key in delta) {
                        if (key[0] == '$') {
                            delete from[key.substr(1)];
                            continue;
                        }

                        if (!(key in from)) {
                            from[key] = delta[key];
                            continue;
                        }

                        if (Array.isArray(delta[key])) {
                            from[key] = delta[key];
                            continue;
                        }
                        if (isObject(delta[key])) {
                            from[key] = merge(from[key], delta[key]);
                            continue;
                        }

                        from[key] = delta[key];
                    }

                    return from;
                }

                socket.on('time', (message) => {
                    let serverOffset = message.payload.offset;
                    let serverTime = message.payload.serverTime;
                    let currentTime = new Date().getTime();
                    latency = currentTime - latencyStart;
                    offsetTime = currentTime - serverTime;
                    let realTime = currentTime + offsetTime + Math.ceil(latency / 2);
                    console.log('Latency Start: ', latencyStart);
                    console.log('Latency: ', latency);
                    console.log('Offset Time: ', offsetTime);
                    console.log('Server Offset: ', serverOffset);
                    console.log('Server Time: ', serverTime);
                    console.log('Client Time: ', currentTime);
                    console.log('Real Time: ', realTime);
                });

                socket.on('game', (message) => {
                    console.log('Delta: ', message);
                    if (!message) return;
                    message = merge(lastMessage || {}, message);

                    let localPlayer = message.players[socket.user.id];
                    if (localPlayer) note.textContent = 'Status: ingame';
                    // console.log('Game: ', message);

                    message.local = Object.assign({}, socket.user, localPlayer);
                    sendFrameMessage(message);
                    // console.timeEnd('ActionLoop');

                    if (message && message.events && message.events.gameover) {
                        lastMessage = null;
                    } else {
                        lastMessage = message;
                    }
                });

                socket.on('private', (message) => {
                    console.log('Private Data: ', message);

                    if (lastMessage) {
                        lastMessage.players[socket.user.id] = Object.assign(
                            {},
                            lastMessage.players[socket.user.id],
                            message
                        );

                        message.local = Object.assign({}, message.local, message);
                    }
                    // message.local = Object.assign({}, socket.user, localPlayer);
                    sendFrameMessage(lastMessage);
                    console.timeEnd('ActionLoop');
                });

                socket.on('disconnect', () => {
                    note.textContent = 'Status: offline';
                    window.sessionStorage.setItem('connected', false);
                });
            }

            function updateUser(username) {
                if (!username || username.length == 0) return;
                window.sessionStorage.setItem('name', username);
                // window.sessionStorage.setItem(username, stringHashCode(username));
            }

            function getUsername() {
                return window.sessionStorage.getItem('name') || '';
            }

            let checkboxScaled = document.getElementById('scaled');
            checkboxScaled.onclick= (event) => {
                scaled = event.target.checked;
                if( scaled ) {
                    iframe.style.width = '1920px';
                    iframe.style.height = '1080px';
                }
                else {
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                }
                
                localStorage.setItem('scaled', scaled);
                onResize();
            }

            scaled = localStorage.getItem('scaled') || false;
            checkboxScaled.checked = scaled;
            onResize();
            
            document.getElementById('maximize').onclick = (event) => {
                openFullscreen(maincontent);
            }
            
            document.getElementById('leavegame').onclick = (event) => {
                speechSynthesis.cancel();
                if (socket) {
                    socket.emit('action', { type: 'leave', payload: {} });
                }
                iframe.style.display = 'none';
                note.textContent = 'Status: offline';
            };

            document.getElementById('joingame').onclick = (event) => {
                let displayname = getUsername();
                if (displayname.trim().length == 0) {
                    alert('Please enter a username.');
                    return;
                }

                iframe.src = '/iframe';

                iframe.onload = function () {
                    console.log('game-sandbox is loaded');
                    setTimeout(() => {
                        connect(displayname, () => {
                            if (socket) socket.emit('action', { type: 'join', payload: {} });
                        });
                    }, 200);
                };
            };

            document.getElementById('reload').onclick = (event) => {
                if (socket) socket.emit('reload', 'now!');
            };

            function attachToFrame() {
                window.addEventListener('message', recvFrameMessage, false);
            }

            function detachFromFrame() {
                window.removeEventListener('message', recvFrameMessage, false);
            }

            function sendFrameMessage(msg) {
                if (iframe) iframe.contentWindow.postMessage(msg, '*');
            }

            function recvFrameMessage(evt) {
                let data = evt.data;
                if (data.type == '__ready') {
                    return;
                }
                // console.time('ActionLoop');
                if (socket) socket.emit('action', data);
            }

            function onLoad() {
                attachToFrame();

                let connected = window.sessionStorage.getItem('connected');
                if (typeof connected !== 'undefined' && connected == 'true') {
                    let displayname = getUsername();
                    if (displayname.trim().length == 0) {
                        return;
                    }

                    note.textContent = 'Status: reconnecting...';

                    setTimeout(() => {
                        connect(displayname, () => {
                            if (socket) socket.emit('action', { type: 'join', payload: {} });
                        });
                    }, 500);
                }
            }
            onLoad();
            console.log('Simulator Loaded');
        </script>
    </body>
</html>
