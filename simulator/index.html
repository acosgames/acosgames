<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />

        <title>SIMULATOR - FiveSecondGames</title>
        <meta name="description" content="FiveSecondGames" />
        <meta name="author" content="FSG" />
        <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://localhost:* https://*.fivesecondgames.com https://*.socket.io https://*.jsdelivr.net 'unsafe-inline';" />

        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
            crossorigin="anonymous"
        />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
            crossorigin="anonymous"
        ></script>

        <script
            src="https://cdn.socket.io/3.1.3/socket.io.min.js"
            integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
            crossorigin="anonymous"
        ></script>
    </head>
    <body>
        <style>
            html,
            body {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                background-color:#1a202c;
                color:white;
            }


            #wrapper {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                /* height: 100%; */
                position:relative;
                /* overflow-x:hidden; */
            }

            #wrapper .sidebar {
                padding-bottom:1rem;
                width:50%;
            }

            #wrapper #maincontent {
                /* flex-basis: 0;
                flex-grow: 999; */
                
            }

            #wrapper {
                border: 0;
                border-spacing: 0;
                
            }

            #maincontent::after {
                content: '';
                display:block;
                /* padding-bottom:56.25%; */
            }
            #maincontent {
                position:relative;
                width:100%;
                /* max-width:1000px; */
                /* aspect-ratio: 16 / 9; */
                /* max-width: 1000px; */
                /* background-color: red; */
                /* resize: both; */
                /* background-color:red; */
                
            }
            #placeholder {
                /* width:100%;
                height:100%;
                object-fit:fill;
                position:absolute;
                background-color:transparent; */

                display: flex;
                justify-content: center;
                align-items: center;
                            
            }
            #game-sandbox {
                width: 100%;
                height: 100%;
                position:absolute;
                backface-visibility: hidden;
                /* background-color:white; */
                /* border: 4px solid rgb(11, 14, 19); */
                border-radius:8px;
            }
        </style>
        <div id="wrapper">
            <div class="sidebar">
                <h2 id="note">Status: offline</h2>
                <form>
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input
                            type="text"
                            class="form-control"
                            id="username"
                            aria-describedby="userHelp"
                            placeholder="Enter username"
                        />
                        <!-- <small id="userHelp" class="form-text text-muted">Enter a username to join the game</small> -->
                    </div>

                    <button id="joingame" type="button" class="btn btn-primary">Join Game</button>
                    <button id="leavegame" type="button" class="btn btn-primary">Leave Game</button>
                    <button id="startgame" type="button" class="btn btn-primary">Start Game</button>
                    <button id="reload" type="button" class="btn btn-primary">Reload Game</button>
                    <button id="maximize" type="button" class="btn btn-primary">Maximize Window</button>
                    <br />
                    <div style="display:flex; flex-direction: row; justify-items: center; align-items:center; flex-wrap: wrap; ">  
                        <div >
                            <!-- <input style="margin-left:2rem; margin-right:0.5rem; " type="checkbox" class="form-check-input" id="scaled"> -->
                            <select id="screenType">
                                <option value="1">Full Screen</option>
                                <option value="2">Fixed Resolution</option>
                                <option value="3">Scaled Resolution</option>
                            </select>
                            <!-- <label class="form-check-label" for="exampleCheck1" style="font-size:0.8rem;">Scale Viewport?</label> -->
                        </div>
                        <div id="viewportResolution">
                            <label style="display:inline-block; padding-right:0.5rem;font-size:0.8rem;" for="resolution">Resolution</label>
                            <input
                                type="text"
                                class=""
                                id="resolution"
                                aria-describedby=""
                                placeholder="16:9"
                                style="width:60px"
                            />
                        </div>
                        <div id="viewportSize">
                        <label style="padding-left:1rem; padding-right:0.5rem; display:inline-block; font-size:0.8rem;" for="maxwidth">Width (px)</label>
                        <input
                            type="text"
                            class=""
                            id="maxwidth"
                            aria-describedby=""
                            placeholder="1920"
                            style="width:50px"
                        />
                        <label style="padding-left:1rem; padding-right:0.5rem; display:inline-block; font-size:0.8rem;" for="maxheight">Height (px)</label>
                        <input
                            type="text"
                            class=""
                            id="maxheight"
                            disabled
                            aria-describedby=""
                            value="1080"
                            style="width:50px"
                        />
                    </div>
                        
                    </div>
                </form>
            </div>
            <div id="placeholder" style="justify-content:center;align-content:center;">
                <div id="maincontent">
                    <!-- <div id="placeholder">
                        
                    </div> -->
                    <iframe id="game-sandbox" sandbox="allow-scripts" src="/iframe"></iframe>
                </div>
            </div>
        </div>

        <script>
            var socket = null;
            var lastMessage = null;
            let note = document.getElementById('note');
            let maincontent = document.getElementById('maincontent');
            let placeholder = document.getElementById('placeholder');
            let iframe = document.getElementById('game-sandbox');

            let nameField = document.getElementById('username');
            let checkboxScaled = document.getElementById('scaled');
            let inputResolution = document.getElementById('resolution');
            let inputWidth = document.getElementById('maxwidth');
            let inputHeight = document.getElementById('maxheight');
            let selectScreenType = document.getElementById('screenType');
            let screenType = 1;

            let viewportSize = document.getElementById('viewportSize');
            let viewportResolution = document.getElementById('viewportResolution');

            nameField.value = getUsername();
            nameField.onkeyup = (event) => {
                let username = event.target.value;
                updateUser(username);
            };

            var resoWidth = 16;
            var resoHeight = 9;
            var resoScale = resoWidth > resoHeight ? (resoWidth / resoHeight) : (resoHeight / resoWidth);
            var resMaxWidth = 1920;
            var resMaxHeight = 1080;

            iframe.style.display = 'none';
            var scaled =false;
            // var CONTENT_WIDTH = 1920;
            // var CONTENT_HEIGHT = 1080;
            var timestamp = 0;
            var THROTTLE = 0;
            
            function openFullscreen(elem) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari */
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) { /* IE11 */
                    elem.msRequestFullscreen();
                }
                // maincontent.style.width = '100%';
                onResize();
            }

            function transformStr(obj) {
                var obj = obj || {},
                    val = '',
                    j;
                for ( j in obj ) {
                val += j + '(' + obj[j] + ') ';
                }
                
                return '-webkit-transform: ' + val + '; ' +
                        '-moz-transform: ' + val + '; ' +
                        'transform: ' + val;
            }

            function checkFullScreen() {
                if (document.fullscreenElement || document.webkitFullscreenElement ||
                    document.mozFullScreenElement)
                        return true;
                else
                        return false;
            }

            function onResize() {
                var now = +new Date,
                    winWidth = window.innerWidth,
                    scale,
                    width,
                    height,
                    offsetTop,
                    offsetLeft;
                
                if ( now - timestamp < THROTTLE  ) {
                    return onResize;
                }
                
                timestamp = now;

                let isFullscreen = checkFullScreen();
                let windowHeight = isFullscreen ? window.screen.height : document.documentElement.clientHeight;
                let windowWidth = isFullscreen ? window.screen.width : document.documentElement.clientWidth;
                var bgWidth = parseInt(getComputedStyle(maincontent).width, 10);
                var bgHeight = parseInt(getComputedStyle(maincontent).height, 10);
                var iframeWidth =  parseInt(getComputedStyle(iframe).width, 10);
                let ratio = 1;

                let wratio = (windowWidth / bgWidth);
                let hratio = (windowHeight / bgHeight );

                let wsteps = (windowWidth / resoWidth);
                let hsteps = (windowHeight / resoHeight);
                let steps = 0;

                 if( wsteps < hsteps ) {
                    steps = wsteps
                }
                else {
                    steps = hsteps
                }   

                bgWidth = (steps * resoWidth);
                bgHeight = (steps * resoHeight);
            
                
           
                   
                if( screenType == '3' ) {
                    maincontent.style.width = bgWidth + 'px';
                    maincontent.style.height = bgHeight + 'px';
                    scale = ((bgWidth / resMaxWidth));

                    iframe.setAttribute('style', transformStr({
                        scale: scale,
                        translateZ: '0'
                    }) + `; transform-origin: left top; width:${resMaxWidth}px; height:${resMaxHeight}px;`);
                } 
                else if( screenType == '2' ) {
                    maincontent.style.width = bgWidth + 'px';
                    maincontent.style.height = bgHeight + 'px';
                    iframe.setAttribute('style', 'width:100%; height:100%;')
                }
                else if(screenType =='1' ) {
                    maincontent.style.width = windowWidth + 'px';
                    maincontent.style.height = windowHeight + 'px';
                    iframe.setAttribute('style', 'width:100%; height:100%;')
                }
            }
            
            function updateFrameSize(newWidth, newHeight) {

                resoWidth = newWidth || resoWidth;
                resoHeight = newHeight || resoHeight;

                let steps = resMaxWidth / resoWidth;
                resMaxHeight = resoHeight * steps;
                inputHeight.value = resMaxHeight;

                resoScale =  resoWidth > resoHeight ? (resoWidth / resoHeight) : (resoHeight / resoWidth);

                if( screenType == '1' ) {
                    viewportSize.style.display = 'none';
                    viewportResolution.style.display = 'none';
                }
                else if(screenType == '2' ) {
                    viewportSize.style.display = 'none';
                    viewportResolution.style.display = 'block';
                }
                else {
                    viewportSize.style.display = 'block';
                    viewportResolution.style.display = 'block';
                }

                onResize();
            }

            window.addEventListener('resize', onResize, false);

            function updateUser(username) {
                if (!username || username.length == 0) return;
                window.sessionStorage.setItem('name', username);
                // window.sessionStorage.setItem(username, stringHashCode(username));
            }

            function getUsername() {
                return window.sessionStorage.getItem('name') || '';
            }

           
            selectScreenType.onchange = (event) => {
                console.log(event.target.value);
                
                screenType = event.target.value;
                updateFrameSize();
                localStorage.setItem('screenType', screenType);
            }

            

            inputResolution.oninput = (event) => {
                let val = event.target.value;
                let parts = val.split(':');
                if( !parts || parts.length != 2 ) {
                    return;
                }

                resoWidth = 1*parts[0];
                resoHeight = 1*parts[1];
                if( !Number.isInteger(resoWidth) || !Number.isInteger(resoHeight))
                    return;

                if( resoWidth <= 0 || resoHeight <= 0 )
                    return;

                localStorage.setItem('resoWidth', resoWidth);
                localStorage.setItem('resoHeight', resoHeight);
                
                updateFrameSize(resoWidth, resoHeight);
            }

            inputWidth.onchange = (event) => {
                let val = event.target.value;
                
                val = 1*val;
                if( !Number.isInteger(val))
                    return;

                
                    if( val <= 0  )
                        return;

                resMaxWidth = val;

                let steps = resMaxWidth / resoWidth;
                resMaxHeight = resoHeight * steps;

                localStorage.setItem('resMaxWidth', resMaxWidth);
                localStorage.setItem('resMaxHeight', resMaxHeight);

                updateFrameSize(resoWidth,resoHeight);
            }

           
          
            screenType =  localStorage.getItem('screenType') || "1";
            resoWidth = localStorage.getItem('resoWidth') || 16;
            resoHeight = localStorage.getItem('resoHeight') || 9;
            resMaxWidth = localStorage.getItem('resMaxWidth') || 1920;
            resMaxHeight = localStorage.getItem('resMaxHeight') || 1080;
            inputResolution.value = resoWidth + ':' + resoHeight;
            inputWidth.value = resMaxWidth;
            inputHeight.value = resMaxHeight;
            selectScreenType.value = screenType;
            updateFrameSize();
            
            document.getElementById('maximize').onclick = (event) => {
                openFullscreen(placeholder);
            }
            
            document.getElementById('leavegame').onclick = (event) => {
                // speechSynthesis.cancel();
                if (socket) {
                    socket.emit('action', { type: 'leave', payload: {} });
                }
                iframe.style.display = 'none';
                note.textContent = 'Status: offline';
            };

            document.getElementById('startgame').onclick = (event) => {
                
                if (socket) {
                    socket.emit('action', { type: 'gamestart', payload: null });
                }
            };


            document.getElementById('joingame').onclick = (event) => {
                let displayname = getUsername();
                if (displayname.trim().length == 0) {
                    alert('Please enter a username.');
                    return;
                }

                iframe.src = null;

                iframe.src = '/iframe';

                iframe.onload = function () {
                    console.log('game-sandbox is loaded');
                    setTimeout(() => {
                        connect(displayname, () => {
                            if (socket) socket.emit('action', { type: 'join', payload: {} });
                        });
                    }, 200);
                };
            };

            document.getElementById('reload').onclick = (event) => {
                if (socket) socket.emit('reload', 'now!');
            };








            //--------------------------------------------------
            //WebSockets Connection / Management 
            //--------------------------------------------------
            function connect(username, onjoin) {
                note.textContent = 'Status: connecting...';

                if (socket && !socket.disconnected) {
                    socket.disconnect();
                }

                socket = io('ws://localhost:3200', {
                    transports: ['websocket'],
                    upgrade: true,
                    query: 'username=' + username,
                });

                socket.on('connect', (evt) => {
                    if (onjoin) onjoin(evt);
                    window.sessionStorage.setItem('connected', true);

                    note.textContent = 'Status: connected';
                    iframe.style.display = 'block';
                });

                var latency = 0;
                var latencyStart = 0;
                var offsetTime = 0;
                socket.on('connected', (message) => {
                    //message should have { id, name }
                    socket.user = message;
                    updateLatency();
                });

                function updateLatency() {
                    latencyStart = new Date().getTime();
                    socket.emit('time', { payload: latencyStart });
                }

                function isObject(x) {
                    return x != null && (typeof x === 'object' || typeof x === 'function') && !Array.isArray(x);
                }
                function merge(from, delta) {
                    // if (!this.isObject(delta)) {
                    //     return from;
                    // }
                    if (!Array.isArray(delta) && !isObject(delta)) {
                        if (delta != from) return delta;
                    }

                    for (var key in delta) {
                        if (key[0] == '$') {
                            delete from[key.substr(1)];
                            continue;
                        }

                        if (!(key in from)) {
                            from[key] = delta[key];
                            continue;
                        }

                        if (Array.isArray(delta[key])) {
                            from[key] = delta[key];
                            continue;
                        }
                        if (isObject(delta[key])) {
                            from[key] = merge(from[key], delta[key]);
                            continue;
                        }

                        from[key] = delta[key];
                    }

                    return from;
                }

                socket.on('time', (message) => {
                    let serverOffset = message.payload.offset;
                    let serverTime = message.payload.serverTime;
                    let currentTime = new Date().getTime();
                    latency = currentTime - latencyStart;
                    offsetTime = currentTime - serverTime;
                    let realTime = currentTime + offsetTime + Math.ceil(latency / 2);
                    console.log('Latency Start: ', latencyStart);
                    console.log('Latency: ', latency);
                    console.log('Offset Time: ', offsetTime);
                    console.log('Server Offset: ', serverOffset);
                    console.log('Server Time: ', serverTime);
                    console.log('Client Time: ', currentTime);
                    console.log('Real Time: ', realTime);
                });

                socket.on('join', (message) => {
                    console.log('JOINED: ', message);
                    if (!message) return;
                    lastMessage = {};
                    message = merge(lastMessage || {}, message);

                    let localPlayer = message.players[socket.user.id];
                    if (localPlayer) note.textContent = 'Status: ingame';
                    // console.log('Game: ', message);
                    message.local = Object.assign({}, socket.user, localPlayer);
                    sendFrameMessage(message);
                    // console.timeEnd('ActionLoop');

                    if (message && message.events && message.events.gameover) {
                        lastMessage = null;
                    } else {
                        lastMessage = message;
                    }
                })
                socket.on('game', (message) => {
                    console.log('GAME UPDATE: ', message);
                    if (!message) return;
                    message = merge(lastMessage || {}, message);

                    let localPlayer = message.players[socket.user.id];
                    if (localPlayer) note.textContent = 'Status: ingame';
                    // console.log('Game: ', message);

                    message.local = Object.assign({}, socket.user, localPlayer);
                    sendFrameMessage(message);
                    // console.timeEnd('ActionLoop');

                    if (message && message.events && message.events.gameover) {
                        lastMessage = null;
                    } else {
                        lastMessage = message;
                    }
                });

                socket.on('private', (message) => {
                    console.log('Private Data: ', message);

                    if (lastMessage) {
                        lastMessage.players[socket.user.id] = Object.assign(
                            {},
                            lastMessage.players[socket.user.id],
                            message
                        );

                        message.local = Object.assign({}, message.local, message);
                    }
                    // message.local = Object.assign({}, socket.user, localPlayer);
                    sendFrameMessage(lastMessage);
                    console.timeEnd('ActionLoop');
                });

                socket.on('disconnect', () => {
                    note.textContent = 'Status: offline';
                    window.sessionStorage.setItem('connected', false);
                });
            }

            

            function attachToFrame() {
                window.addEventListener('message', recvFrameMessage, false);
            }

            function detachFromFrame() {
                window.removeEventListener('message', recvFrameMessage, false);
            }

            function sendFrameMessage(msg) {
                if (iframe) iframe.contentWindow.postMessage(msg, '*');
            }

            function recvFrameMessage(evt) {
                let data = evt.data;
                if (data.type == '__ready') {
                    return;
                }
                // console.time('ActionLoop');
                if (socket) socket.emit('action', data);
            }

            function onLoad() {
                attachToFrame();

                let connected = window.sessionStorage.getItem('connected');
                if (typeof connected !== 'undefined' && connected == 'true') {
                    let displayname = getUsername();
                    if (displayname.trim().length == 0) {
                        return;
                    }

                    note.textContent = 'Status: reconnecting...';

                    setTimeout(() => {
                        connect(displayname, () => {
                            if (socket) socket.emit('action', { type: 'join', payload: {} });
                        });
                    }, 500);
                }
            }
            onLoad();
            console.log('Simulator Loaded');
        </script>
    </body>
</html>
